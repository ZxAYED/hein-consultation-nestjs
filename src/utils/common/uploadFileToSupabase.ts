import { ConfigService } from '@nestjs/config';
import { getSupabaseClient } from './supabaseClient';

export const uploadFileToSupabase = async (
  file: Express.Multer.File,
  configService: ConfigService,
  folder = 'files',
) => {
  if (!file?.buffer) throw new Error('File not provided');

  const supabase = getSupabaseClient(configService);

  const safeFileName = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '');
  const filePath = `${folder}/${Date.now()}-${safeFileName}`;

  const { error } = await supabase.storage
    .from('attachments')
    .upload(filePath, file.buffer, {
      contentType: file.mimetype || 'application/octet-stream',
      upsert: true,
    });

  if (error) throw error;

  const { data } = supabase.storage.from('attachments').getPublicUrl(filePath);

  return data.publicUrl;
};
